<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบนิเทศการจัดการเรียนการสอน สกร.ระดับอำเภอแม่ริม</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Sarabun', 'sans-serif'],
            sarabun: ['Sarabun', 'sans-serif'] 
          },
          colors: {
            primary: '#4F46E5', secondary: '#64748B', 
            success: '#10B981', warning: '#F59E0B', danger: '#EF4444'
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #F1F5F9; }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Animations */
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* UI Elements */
    .status-btn { transition: all 0.2s ease; border: 1px solid #E2E8F0; }
    .status-btn:hover { transform: translateY(-2px); }
    .status-btn.active.has { background-color: #10B981; color: white; border-color: #10B981; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }
    .status-btn.active.not-has { background-color: #EF4444; color: white; border-color: #EF4444; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); }
    
    /* Nav Link Styling */
    .nav-link { transition: all 0.2s ease; border-bottom: 2px solid transparent; }
    @media (min-width: 1024px) {
        .nav-link.active { color: #4F46E5; font-weight: 600; border-bottom: 2px solid #4F46E5; background-color: transparent; }
        .nav-link:hover { color: #4F46E5; }
    }
    @media (max-width: 1023px) {
        .nav-link.active { background-color: #EEF2FF; color: #4F46E5; font-weight: 600; border-left: 4px solid #4F46E5; border-bottom: none; }
    }
    
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Admin Visibility Control */
    .admin-only-element { display: none !important; } 
    body.is-admin-mode .admin-only-element { display: flex !important; } 
    body.is-admin-mode button.admin-only-element { display: inline-block !important; }

    /* ================= Print Layout CSS (ปรับปรุงเพื่อ 1 หน้า) ================= */
    @media print {
        @page { 
            size: A4; 
            margin: 0.5cm; /* ขอบกระดาษบาง */
        }
        body { 
            -webkit-print-color-adjust: exact; 
            font-size: 10pt;
        }
        
        body > *:not(#print-layout) { display: none !important; }
        
        #print-layout { 
            display: block !important; 
            position: static !important; 
            width: 100% !important; 
            visibility: visible !important; 
            overflow: visible !important;
        }
        
        .no-print { display: none !important; }
        
        /* บังคับตารางให้กระชับ */
        table td, table th { padding: 4px !important; }
        
        /* จัดการรูปภาพให้เรียงแนวนอน 3 รูป เพื่อประหยัดที่ */
        #p-images-container {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 10px !important;
            margin-top: 10px !important;
        }
        #p-images-container img {
            max-height: 4cm !important;
            width: 100% !important;
            object-fit: cover !important;
            margin-bottom: 0 !important;
        }

        /* ซ่อนการตัดหน้า */
        .page-break { display: none !important; }
        
        /* ปรับส่วนลงชื่อ */
        .signature-section {
            margin-top: 20px !important;
            page-break-inside: avoid;
        }
    }

    #print-layout { display: none; }
  </style>
</head>
<body class="text-slate-800 antialiased flex flex-col min-h-screen">

  <div id="login-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center fade-in px-4 no-print">
    <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md border border-slate-100">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 text-2xl">
          <i class="fas fa-user-shield"></i>
        </div>
        <h3 class="text-2xl font-bold text-slate-800">เข้าสู่ระบบผู้ดูแล</h3>
        <p class="text-slate-500 text-sm mt-1">กรุณากรอกรหัสผ่านเพื่อบันทึกข้อมูล</p>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
          <input type="password" id="admin-password-input" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none text-center tracking-widest" placeholder="••••••••">
        </div>
        <button onclick="handleLogin()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium shadow-lg transition-all">ยืนยัน</button>
        <button onclick="closeLoginModal()" class="w-full py-2 text-slate-400 hover:text-slate-600 text-sm">ยกเลิก</button>
      </div>
    </div>
  </div>

  <div id="loading-spinner" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden no-print">
    <div class="loader mb-4"></div>
    <p class="text-primary font-medium animate-pulse">กำลังประมวลผล...</p>
  </div>

  <nav class="bg-white shadow-md sticky top-0 z-40 w-full no-print">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center shrink-0">
          <div class="flex flex-col">
           <h1 class="text-xl font-bold text-primary">ระบบนิเทศ</h1>
            <span class="text-xs text-slate-500">สกร.ระดับอำเภอแม่ริม</span>
          </div>
        </div>

        <div class="hidden lg:flex lg:items-center lg:space-x-1">
          <button onclick="showPage('data')" class="nav-link px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary active">Dashboard</button>
          <button onclick="showPage('summary')" class="nav-link px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary">สรุปภาพรวม</button>
          <button onclick="showPage('history')" class="nav-link px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary">ประวัติ</button>
          <button onclick="showPage('details')" class="nav-link px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary">รายละเอียด</button>
          <button onclick="showPage('comparison')" class="nav-link px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary">เปรียบเทียบ</button>
          
          <button onclick="showPage('report')" class="nav-link admin-only-element px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary">
             <i class="fas fa-file-pdf mr-1"></i> รายงานการนิเทศ
          </button>

          <button id="nav-assessment" onclick="showPage('assessment')" class="nav-link admin-only-element px-3 py-2 text-sm font-medium text-slate-600 hover:text-primary">
             <i class="fas fa-edit mr-1"></i> บันทึกนิเทศ
          </button>
        </div>

        <div class="hidden lg:flex lg:items-center lg:ml-6">
             <button id="btn-login" onclick="openLoginModal()" class="text-sm px-4 py-2 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 transition"><i class="fas fa-sign-in-alt mr-1"></i> เข้าสู่ระบบ</button>
             <button id="btn-logout" onclick="handleLogout()" class="text-sm px-4 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition hidden"><i class="fas fa-sign-out-alt mr-1"></i> ออกจากระบบ</button>
        </div>

        <div class="flex items-center lg:hidden">
          <button onclick="toggleMobileMenu()" class="text-slate-500 hover:text-primary p-2 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
        </div>
      </div>
    </div>

    <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-slate-100 pb-4 shadow-lg absolute w-full left-0 z-30">
        <div class="px-2 pt-2 space-y-1">
            <button onclick="showPage('data')" class="nav-link w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-chart-pie w-6"></i> Dashboard</button>
            <button onclick="showPage('summary')" class="nav-link w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-chart-line w-6"></i> สรุปภาพรวม</button>
            <button onclick="showPage('history')" class="nav-link w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-history w-6"></i> ประวัติการนิเทศ</button>
            <button onclick="showPage('details')" class="nav-link w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-file-alt w-6"></i> รายละเอียดรายบุคคล</button>
            <button onclick="showPage('comparison')" class="nav-link w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-balance-scale w-6"></i> เปรียบเทียบผล</button>
            
            <button onclick="showPage('report')" class="nav-link admin-only-element w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-file-pdf w-6"></i> รายงานการนิเทศ</button>
            <button id="nav-assessment-mobile" onclick="showPage('assessment')" class="nav-link admin-only-element w-full text-left px-4 py-3 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50"><i class="fas fa-edit w-6"></i> บันทึกการนิเทศ</button>
        </div>
        <div class="border-t border-slate-200 mt-2 pt-4 px-4">
          <button id="btn-login-mobile" onclick="openLoginModal()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-slate-100 text-slate-600"><i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบแอดมิน</button>
          <button id="btn-logout-mobile" onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-red-100 text-red-600 hidden"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
        </div>
    </div>
  </nav>

  <main class="flex-1 w-full bg-slate-50 p-4 lg:p-8 no-print">
       
       <div id="data-page" class="page fade-in max-w-7xl mx-auto flex flex-col h-full">
            <div class="mb-6 md:mb-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Dashboard ภาพรวม</h2>
                <p class="text-slate-500">สถิติข้อมูลการนิเทศ ประจำภาคเรียนที่ 2/2568</p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
                    <div><p class="text-slate-500 text-xs md:text-sm">การนิเทศทั้งหมด</p><h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="total-assessments">0</h3></div>
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-lg md:text-xl"><i class="fas fa-clipboard-list"></i></div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
                    <div><p class="text-slate-500 text-xs md:text-sm">คะแนนเฉลี่ย</p><h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="avg-score">0%</h3></div>
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-lg md:text-xl"><i class="fas fa-percent"></i></div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
                    <div><p class="text-slate-500 text-xs md:text-sm">จำนวนผู้นิเทศ</p><h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="total-supervisors">0</h3></div>
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 text-lg md:text-xl"><i class="fas fa-users"></i></div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
                    <div><p class="text-slate-500 text-xs md:text-sm">ศกร.ระดับตำบล</p><h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="total-Tumbon">0</h3></div>
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 text-lg md:text-xl"><i class="fas fa-map-marker-alt"></i></div>
                </div>
            </div>
            
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800 text-lg">ข้อมูลการนิเทศล่าสุด</h3>
            </div>
            <div id="data-card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-8"></div>
        </div>

        <div id="report-page" class="page hidden fade-in max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 lg:p-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-file-pdf text-primary"></i> ระบบออกรายงานการนิเทศ
                </h2>

                <div class="flex flex-col md:flex-row gap-4 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <div class="flex-1">
                        <label class="block text-xs text-slate-500 mb-1">ค้นหา (ชื่อ/สถานที่)</label>
                        <input type="text" id="report-search" onkeyup="renderReportTable()" placeholder="พิมพ์คำค้นหา..." class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">ศกร.ระดับตำบล</label>
                        <select id="report-filter-tumbon" onchange="renderReportTable()" class="w-full md:w-48 px-4 py-2 rounded-lg border border-slate-300 bg-white">
                            <option value="">ทั้งหมด</option>
                            <option value="ศกร.ระดับตำบลดอนแก้ว">ศกร.ระดับตำบลดอนแก้ว</option>
                            <option value="ศกร.ระดับตำบลริมเหนือ">ศกร.ระดับตำบลริมเหนือ</option>
                            <option value="ศกร.ระดับตำบลริมใต้">ศกร.ระดับตำบลริมใต้</option>
                            <option value="ศกร.ระดับตำบลเหมืองแก้ว">ศกร.ระดับตำบลเหมืองแก้ว</option>
                            <option value="ศกร.ระดับตำบลแม่สา">ศกร.ระดับตำบลแม่สา</option>
                            <option value="ศกร.ระดับตำบลแม่แรม">ศกร.ระดับตำบลแม่แรม</option>
                            <option value="ศกร.ระดับตำบลสันโป่ง">ศกร.ระดับตำบลสันโป่ง</option>
                            <option value="ศกร.ระดับตำบลโป่งแยง">ศกร.ระดับตำบลโป่งแยง</option>
                            <option value="ศกร.ระดับตำบลขี้เหล็ก">ศกร.ระดับตำบลขี้เหล็ก</option>
                            <option value="ศกร.ระดับตำบลห้วยทราย">ศกร.ระดับตำบลห้วยทราย</option>
                            <option value="ศกร.ระดับตำบลสะลวง">ศกร.ระดับตำบลสะลวง</option>
                        </select>
                    </div>
                </div>

                <div class="hidden md:block overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">วันที่</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">สถานที่ / ระดับชั้น</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ผู้นิเทศ</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">คะแนน</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>

                <div id="report-mobile-list" class="md:hidden space-y-4"></div>

                <div id="report-empty-state" class="hidden text-center py-10 text-slate-400">
                    <i class="fas fa-search text-3xl mb-3"></i>
                    <p>ไม่พบข้อมูลที่ค้นหา</p>
                </div>
            </div>
        </div>

        <div id="assessment-page" class="page hidden fade-in max-w-5xl mx-auto">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 lg:p-8 mb-6">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
               <i class="fas fa-edit text-primary"></i> บันทึกข้อมูลการนิเทศ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
               <div class="form-group"><label class="block text-sm font-medium text-slate-700 mb-2">วันที่นิเทศ</label><input type="date" id="assessment-date" class="w-full px-4 py-2 rounded-lg border border-slate-300"></div>
               
               <div class="form-group"><label class="block text-sm font-medium text-slate-700 mb-2">ผู้นิเทศ</label>
                  <select id="supervisor" class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white">
                    <option value="">เลือกผู้นิเทศ</option>
                    <option value="นายธนพงษ์ อมฤตวิสุทธิ์">นายธนพงษ์ อมฤตวิสุทธิ์</option>
                    <option value="นางสาวปิยะนุช มูลเกี้ยว">นางสาวปิยะนุช มูลเกี้ยว</option>
                    <option value="นายไกรเทพ แถวถาคำ">นายไกรเทพ แถวถาคำ</option>
                    <option value="นางประภาศรี ตาแพร่">นางประภาศรี ตาแพร่</option>
                 </select>
               </div>

               <div class="form-group">
                  <label class="block text-sm font-medium text-slate-700 mb-2">ครูผู้รับการนิเทศ</label>
                  <select id="TeacherName" class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white">
                      <option value="">-- เลือกรายชื่อครู --</option>
                  </select>
               </div>

               <div class="form-group">
                  <label class="block text-sm font-medium text-slate-700 mb-2">ศกร.ระดับตำบล</label>
                  <select id="tumbon" class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white">
                      <option value="">เลือก ศกร.ระดับตำบล</option>
                     <option value="ศกร.ระดับตำบลดอนแก้ว">ศกร.ระดับตำบลดอนแก้ว</option>
                             <option value="ศกร.ระดับตำบลดอนแก้ว">ศกร.ระดับตำบลดอนแก้ว</option>
                            <option value="ศกร.ระดับตำบลริมเหนือ">ศกร.ระดับตำบลริมเหนือ</option>
                            <option value="ศกร.ระดับตำบลริมใต้">ศกร.ระดับตำบลริมใต้</option>
                            <option value="ศกร.ระดับตำบลเหมืองแก้ว">ศกร.ระดับตำบลเหมืองแก้ว</option>
                            <option value="ศกร.ระดับตำบลแม่สา">ศกร.ระดับตำบลแม่สา</option>
                            <option value="ศกร.ระดับตำบลแม่แรม">ศกร.ระดับตำบลแม่แรม</option>
                            <option value="ศกร.ระดับตำบลสันโป่ง">ศกร.ระดับตำบลสันโป่ง</option>
                            <option value="ศกร.ระดับตำบลโป่งแยง">ศกร.ระดับตำบลโป่งแยง</option>
                            <option value="ศกร.ระดับตำบลขี้เหล็ก">ศกร.ระดับตำบลขี้เหล็ก</option>
                            <option value="ศกร.ระดับตำบลห้วยทราย">ศกร.ระดับตำบลห้วยทราย</option>
                            <option value="ศกร.ระดับตำบลสะลวง">ศกร.ระดับตำบลสะลวง</option>
                  </select>
               </div>
               <div class="form-group"><label class="block text-sm font-medium text-slate-700 mb-2">ระดับชั้น</label>
                 <select id="class-level" class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white">
                   <option value="">เลือกระดับชั้น</option>
                   <option value="ประถมศึกษา">ประถมศึกษา</option><option value="มัธยมศึกษาตอนต้น">มัธยมศึกษาตอนต้น</option><option value="มัธยมศึกษาตอนปลาย">มัธยมศึกษาตอนปลาย</option>
                 </select>
               </div>
               <div class="form-group"><label class="block text-sm font-medium text-slate-700 mb-2">ครั้งที่</label>
                 <select id="assessment-round" class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white">
                    <option value="1">ครั้งที่ 1</option><option value="2">ครั้งที่ 2</option>
                 </select>
               </div>
            </div>
            
            <div id="assessment-form-container" class="space-y-8"></div>
            
            <div class="mt-8 pt-8 border-t border-slate-200 space-y-6">
                <h3 class="text-lg font-bold text-slate-800">ตอนที่ 2 บันทึกเพิ่มเติม & รูปภาพ</h3>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">1. จุดเด่นในการจัดกิจกรรมการเรียนรู้</label>
                    <textarea id="strengths" rows="3" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all placeholder-slate-400" placeholder="ระบุจุดเด่น..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">2. จุดที่ควรพัฒนา</label>
                    <textarea id="improvements" rows="3" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all placeholder-slate-400" placeholder="ระบุจุดที่ควรพัฒนา..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">หมายเหตุ/ข้อเสนอแนะ</label>
                    <textarea id="notes" rows="2" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all placeholder-slate-400" placeholder="ระบุหมายเหตุ..."></textarea>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <label class="block text-sm font-medium text-slate-700 mb-2">แนบภาพประกอบ (สูงสุด 3 รูป)</label>
                    <input type="file" id="image-upload" multiple accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-4 cursor-pointer">
                    <div id="image-preview-container" class="grid grid-cols-3 gap-4"></div>
                    <p class="text-xs text-slate-400 mt-2">* อัปโหลดได้ไม่เกิน 3 รูป หากเกินระบบจะเลือก 3 รูปแรก</p>
                </div>
            </div>

            <div class="mt-10 flex flex-col-reverse sm:flex-row gap-4 justify-center">
                <button onclick="clearAll()" class="w-full sm:w-auto px-8 py-3 rounded-xl border border-slate-300 text-slate-600 font-medium hover:bg-slate-50 hover:text-red-600 transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i> ล้างข้อมูล
                </button>
                <button onclick="saveAssessment()" id="btn-save" class="w-full sm:w-auto px-8 py-3 rounded-xl bg-primary text-white font-medium hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-1">
                    <i class="fas fa-save mr-2"></i> บันทึกข้อมูล
                </button>
            </div>
          </div>
        </div>

        <div id="history-page" class="page hidden fade-in max-w-6xl mx-auto">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 lg:p-8">
             <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                 <h2 class="text-2xl font-bold text-slate-800"><i class="fas fa-history text-primary"></i> ประวัติการนิเทศ</h2>
                 <div class="flex flex-wrap gap-2 w-full md:w-auto">
                   <select id="filter-Tumbon" class="px-3 py-2 rounded-lg border border-slate-300 text-sm flex-1 md:flex-none"><option value="">ทุกตำบล</option></select>
                   <button onclick="filterHistory()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700"><i class="fas fa-filter"></i> ค้นหา</button>
                </div>
             </div>
             <div id="history-content" class="space-y-4">
               <div class="text-center py-12 text-slate-400"><i class="fas fa-spinner fa-spin text-3xl mb-3"></i><p>กำลังโหลด...</p></div>
             </div>
          </div>
        </div>

        <div id="details-page" class="page hidden fade-in max-w-5xl mx-auto">
           <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-slate-800">รายละเอียดรายบุคคล</h2>
              </div>
              <div class="mb-8"><select id="details-selector" class="w-full px-4 py-3 rounded-lg border border-slate-300 bg-white"><option>กำลังโหลดรายการ...</option></select></div>
              <div id="details-charts-container" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <div class="bg-slate-50 p-4 rounded-xl"><canvas id="details-chart-1"></canvas></div>
                  <div class="bg-slate-50 p-4 rounded-xl"><div class="h-64"><canvas id="details-chart-2"></canvas></div></div>
              </div>
           </div>
        </div>

        <div id="comparison-page" class="page hidden fade-in max-w-5xl mx-auto">
           <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
             <h2 class="text-2xl font-bold text-slate-800 mb-6">เปรียบเทียบผล</h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end bg-slate-50 p-4 rounded-xl">
                 <div><label class="text-xs text-slate-500">ชุดที่ 1</label><select id="comparison-selector-1" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white"></select></div>
                 <div><label class="text-xs text-slate-500">ชุดที่ 2</label><select id="comparison-selector-2" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white"></select></div>
                 <button onclick="renderComparisonChart()" class="bg-primary text-white py-2 rounded-lg text-sm hover:bg-indigo-700 w-full">เปรียบเทียบ</button>
              </div>
              <div id="comparison-chart-container" class="hidden h-96"><canvas id="comparison-chart"></canvas></div>
           </div>
        </div>

        <div id="summary-page" class="page hidden fade-in max-w-7xl mx-auto">
           <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
               <h2 class="text-2xl font-bold text-slate-800 mb-6">สรุปภาพรวมเชิงลึก</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <div class="p-4 border border-slate-100 rounded-xl shadow-sm bg-slate-50">
                     <h3 class="font-semibold text-slate-700 mb-2 text-center text-sm">คะแนนเฉลี่ยรายด้าน</h3>
                     <div class="h-60 relative w-full"><canvas id="summary-chart-by-category"></canvas></div>
                 </div>
                 <div class="p-4 border border-slate-100 rounded-xl shadow-sm bg-slate-50">
                    <h3 class="font-semibold text-slate-700 mb-2 text-center text-sm">สัดส่วนรายผู้นิเทศ</h3>
                    <div class="h-60 relative w-full"><canvas id="summary-chart-by-supervisor"></canvas></div>
                  </div>
                 <div class="p-4 border border-slate-100 rounded-xl shadow-sm bg-slate-50 md:col-span-2 lg:col-span-1">
                    <h3 class="font-semibold text-slate-700 mb-2 text-center text-sm">แนวโน้มรายระดับชั้น</h3>
                    <div class="h-60 relative w-full"><canvas id="summary-chart-by-class"></canvas></div>
                 </div>
              </div>
           </div>
        </div>
        
    <footer class="mt-8 pt-6 border-t border-slate-200 text-center pb-2 no-print">
        <p class="text-slate-400 text-xs sm:text-sm font-light">
            &copy; 2025 ระบบนิเทศการจัดการเรียนการสอน สกร.ระดับอำเภอแม่ริม
        </p>
        <p class="text-slate-400 text-xs sm:text-sm font-light mt-1">
            พัฒนาระบบโดย <span class="font-medium text-slate-500">นายยุรนันท์ ขันแข่งบุญ</span> ครู ศกร.ระดับตำบลสันติสุข
        </p>
    </footer>

  </main>

  <div id="print-layout">
    <div class="mx-auto" style="width: 100%; max-width: 100%;">
        <div class="flex items-center justify-start gap-5 mb-4 border-b border-gray-300 pb-4">
            <img src="https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/4x8hoZamSJb4fiPtRw5f/pub/7qCw8VNjRFhIY9yljBET/New-Logo.png" style="width: 2.2cm; height: auto;" alt="Garuda">
            
            <div class="text-left">
                <h1 class="text-lg font-bold leading-tight">แบบรายงานผลการนิเทศการจัดการเรียนการสอน</h1>
                <h2 class="text-base font-bold text-slate-800 leading-tight mt-1">ศูนย์ส่งเสริมการเรียนรู้ระดับอำเภอแม่ริม</h2>
                <p class="text-sm text-slate-600 mt-1">ภาคเรียนที่ 2 ปีการศึกษา 2568</p>
            </div>
        </div>

        <div class="mb-4 text-sm leading-snug border-b border-gray-300 pb-2">
            <div class="grid grid-cols-2 gap-x-2 gap-y-1">
                <div class="col-span-1"><strong>สถานที่:</strong> <span id="p-tumbon"></span></div>
                <div class="col-span-1"><strong>วันที่:</strong> <span id="p-date"></span></div>
                <div class="col-span-1"><strong>ครูผู้สอน:</strong> <span id="p-teacher-name"></span></div>
                <div class="col-span-1"><strong>ระดับชั้น:</strong> <span id="p-class"></span></div>
                <div class="col-span-1"><strong>ครั้งที่:</strong> <span id="p-round"></span></div>
                <div class="col-span-1"><strong>ผู้นิเทศ:</strong> <span id="p-supervisor"></span></div>
            </div>
        </div>

       <table class="w-full border-collapse border border-black mb-2 text-[10px] leading-tight">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-black p-1 text-left w-3/4">รายการประเมิน</th>
                    <th class="border border-black p-1 text-center">ผล</th>
                </tr>
            </thead>
            <tbody id="p-table-body"></tbody>
        </table>

        <div class="mb-2 space-y-2 text-xs">
            <div class="border border-black p-2 rounded">
                <strong class="underline">จุดเด่น:</strong> <span id="p-strengths" class="ml-1">-</span>
            </div>
            <div class="border border-black p-2 rounded">
                <strong class="underline">สิ่งที่ควรพัฒนา:</strong> <span id="p-improvements" class="ml-1">-</span>
            </div>
            <div class="border border-black p-2 rounded">
                <strong class="underline">ข้อเสนอแนะ:</strong> <span id="p-notes" class="ml-1">-</span>
            </div>
        </div>
        
        <div class="mt-2" id="p-images-section">
            <div id="p-images-container" class="grid grid-cols-3 gap-2"></div>
        </div>

        <div class="signature-section mt-4 flex justify-between items-end px-4 break-inside-avoid">
            <div class="text-center">
                <p class="mb-1 text-xs">ลงชื่อ........................................ผู้รับการนิเทศ</p>
                <p class="mb-1 text-xs">( <span id="p-sign-teacher"></span> )</p>
                <p class="leading-snug text-xs">ตำแหน่ง ครูศูนย์การเรียนรู้</p>
            </div>
            <div class="text-center">
                <p class="mb-1 text-xs">ลงชื่อ........................................ผู้นิเทศ</p>
                <p class="mb-1 text-xs">( <span id="p-sign-name"></span> )</p>
                <p class="leading-snug text-xs">ตำแหน่ง.............................</p>
            </div>
        </div>
    </div>
  </div>

  <script>
    //================================================================
    //                 LOGIC & CONFIGURATION
    //================================================================

    // --- กำหนดรายชื่อครู ---
    const TEACHER_LIST = [
        "นางฐานิธัญพิมพ์ พัฒศิริ",
        "นางสาวภานุมาศ นาระต๊ะ",
        "นางณิชาพร ใจพรมมา",
        "นายยุรนันท์ ขันแข่งบุญ",
    ];

    // 1. โครงสร้างแบบประเมิน
    const assessmentStructure = [
        { 
            title: "1. ปัจจัยป้อน (Input)", 
            color: "indigo", 
            items: [ 
                { id: "q1_1", text: "1.1 การมอบหมายให้ครูผู้สอนเตรียมการจัดกระบวนการเรียนรู้" }, 
                { id: "q1_2", text: "1.2 การพัฒนาครูผู้สอนในการใช้เทคโนโลยี (Google Classroom, App)" },
                { id: "q1_3", text: "1.3 การพัฒนาบุคลากร เรื่องการจัดกระบวนการเรียนรู้เชิงรุก (Active Learning)" },
                { id: "q1_4", text: "1.4 การวางแผนนำผลการทดสอบ N-NET และผลประเมินมาใช้วางแผน" },
                { id: "q1_5", text: "1.5 การเตรียมข้อมูลเด็กตกหล่น/ออกกลางคัน/กลุ่มเปราะบาง" }
            ] 
        },
        { 
            title: "2. กระบวนการ (Process)", 
            color: "amber", 
            items: [ 
                { id: "q2_1", text: "2.1 จัดกระบวนการเรียนรู้ตามระดับการเรียนรู้ (แผน/สื่อ/เทคนิค)" }, 
                { id: "q2_2", text: "2.2 ครูนำเทคโนโลยีที่ทันสมัย (AI) มาใช้จัดการเรียนรู้" }, 
                { id: "q2_3", text: "2.3 จัดกระบวนการเรียนรู้เชิงรุก (Active Learning) ให้เกิดทักษะแห่งอนาคต" },
                { id: "q2_4", text: "2.4 ครูบันทึกหลังสอน เน้นสภาพปัญหาและนำไปแก้ไข (วิจัยในชั้นเรียน)" },
                { id: "q2_5", text: "2.5 นำผล N-NET มาใช้เป็นข้อมูลวางแผนพัฒนาการจัดการเรียนรู้" },
                { id: "q2_6", text: "2.6 จัดทำข้อมูลส่งต่อสำหรับเด็กตกหล่น/กลุ่มเปราะบาง" }
            ] 
        },
        { 
            title: "3. ผลผลิต (Output) / ผลลัพธ์ (Outcome)", 
            color: "emerald", 
            items: [ 
                { id: "q3_1", text: "3.1 ผลสัมฤทธิ์ทางการเรียนปลายภาคเรียนของผู้เรียน" }, 
                { id: "q3_2", text: "3.2 ผลการทดสอบ N-NET ผ่านเกณฑ์ที่กำหนด" },
                { id: "q3_3", text: "3.3 จำนวนเด็กตกหล่นที่ได้เข้าเรียน/ฝึกอาชีพ" }
            ] 
        }
    ];

    let allAssessments = [];
    let chartInstances = {};
    let isUpdateMode = false;
    let updateId = null;
    let uploadedImages = []; 

    // 2. การจับคู่ตัวแปรสำหรับกราฟ
    const questionMapping = { 
        '1. ปัจจัยป้อน (Input)': ['q1_1', 'q1_2', 'q1_3', 'q1_4', 'q1_5'], 
        '2. กระบวนการ (Process)': ['q2_1', 'q2_2', 'q2_3', 'q2_4', 'q2_5', 'q2_6'], 
        '3. ผลผลิต (Output)': ['q3_1', 'q3_2', 'q3_3'] 
    };
    
    const activityStepMapping = { 
        'Input': ['q1_1', 'q1_2', 'q1_3', 'q1_4', 'q1_5'], 
        'Process': ['q2_1', 'q2_2', 'q2_3', 'q2_4', 'q2_5', 'q2_6'], 
        'Output': ['q3_1', 'q3_2', 'q3_3'] 
    };

    document.addEventListener('DOMContentLoaded', () => {
      populateTeacherList();
      generateAssessmentForm(); 
      document.getElementById('assessment-date').valueAsDate = new Date();
      loadInitialData();
      document.getElementById('details-selector').addEventListener('change', renderDetailsCharts);
      document.getElementById('image-upload').addEventListener('change', handleImageUpload);
      checkLoginState();
      showPage('data');
    });

    // ฟังก์ชันเติมรายชื่อครู
    function populateTeacherList() {
        const select = document.getElementById('TeacherName');
        if(select) {
            TEACHER_LIST.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.text = name;
                select.appendChild(option);
            });
        }
    }

    // --- Image Upload Handling ---
    function handleImageUpload(e) {
        const files = Array.from(e.target.files).slice(0, 3);
        const container = document.getElementById('image-preview-container');
        container.innerHTML = '';
        uploadedImages = [];
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64String = event.target.result;
                uploadedImages.push(base64String);
                const div = document.createElement('div');
                div.className = 'relative group h-24 w-full rounded-lg overflow-hidden border border-slate-200';
                div.innerHTML = `<img src="${base64String}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center text-white text-xs">พร้อมอัปโหลด</div>`;
                container.appendChild(div);
            }
            reader.readAsDataURL(file);
        });
    }

    // --- Core Logic : สร้างฟอร์ม ---
    function generateAssessmentForm() {
      const container = document.getElementById('assessment-form-container');
      if (!container) return;
      
      let html = '<h3 class="text-lg font-bold text-slate-800 mb-4">ตอนที่ 1 ประเด็นการนิเทศ</h3>';
      assessmentStructure.forEach(section => {
        html += `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-6">
            <div class="bg-${section.color}-50 px-6 py-4 border-b border-${section.color}-100">
                <h3 class="font-bold text-${section.color}-800 text-lg">${section.title}</h3>
            </div>
            <div class="p-6 space-y-4">`;
        
        if (section.subsections) {
            section.subsections.forEach(sub => {
                html += `<h4 class="font-semibold text-slate-600 bg-slate-50 p-2 rounded-lg mt-2">${sub.subtitle}</h4>`;
                sub.items.forEach(item => html += createAssessmentItem(item));
            });
        } else if (section.items) {
          section.items.forEach(item => html += createAssessmentItem(item));
        }
        html += `</div></div>`;
      });
      container.innerHTML = html;
    }

    function createAssessmentItem(item) {
      return `<div class="assessment-item flex flex-col sm:flex-row sm:items-center justify-between gap-4 p-4 rounded-lg hover:bg-slate-50 border border-slate-100" data-id="${item.id}">
        <span class="text-slate-700 text-sm flex-1">${item.text}</span>
        <div class="flex gap-2 shrink-0">
            <button onclick="setStatus(this, 'has')" class="status-btn has px-6 py-2 rounded-full text-sm font-medium text-slate-500 bg-white"><i class="fas fa-check"></i> มี</button>
            <button onclick="setStatus(this, 'not-has')" class="status-btn not-has px-6 py-2 rounded-full text-sm font-medium text-slate-500 bg-white"><i class="fas fa-times"></i> ไม่มี</button>
        </div>
      </div>`;
    }

    function setStatus(btn, status) {
      const item = btn.closest('.assessment-item');
      item.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      item.dataset.status = (status === 'has') ? 'มี' : 'ไม่มี';
    }

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(pageId + '-page').classList.remove('hidden');
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(pageId)) link.classList.add('active');
      });
      // ปิดเมนูมือถืออัตโนมัติเมื่อเปลี่ยนหน้า
      document.getElementById('mobile-menu').classList.add('hidden');
      if (['history', 'data', 'details', 'comparison', 'summary', 'report'].includes(pageId)) refreshAllData(allAssessments);
    }
    
    function toggleMobileMenu() { 
        document.getElementById('mobile-menu').classList.toggle('hidden');
    }

    function loadInitialData() {
       document.getElementById('loading-spinner').classList.remove('hidden');
       if (typeof google !== 'undefined' && google.script) {
         google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onFailure).getAssessmentData();
       } else { setTimeout(() => onDataLoaded(JSON.parse(localStorage.getItem('db')||'[]')), 500); }
    }

    function onDataLoaded(data) {
       document.getElementById('loading-spinner').classList.add('hidden');
       allAssessments = data || [];
       refreshAllData(allAssessments);
    }

    function saveAssessment() {
       const basic = {
         AssessmentDate: document.getElementById('assessment-date').value,
         Supervisor: document.getElementById('supervisor').value,
         TeacherName: document.getElementById('TeacherName').value,
         Tumbon: document.getElementById('tumbon').value,
         ClassLevel: document.getElementById('class-level').value,
         AssessmentRound: document.getElementById('assessment-round').value
       };
       if(Object.values(basic).some(v=>!v)) return Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกข้อมูลส่วนหัว (วันที่, ผู้นิเทศ, ครูผู้รับการนิเทศ, สถานที่ ฯลฯ)','warning');

       let score=0, total=0;
       const items = {};
       document.querySelectorAll('.assessment-item').forEach(i => {
          const s = i.dataset.status;
          items[i.dataset.id] = s || 'ไม่มี';
          if(s==='มี') score++;
          total++;
       });
       const payload = {
         ...basic, ...items,
         Strengths: document.getElementById('strengths').value,
         Improvements: document.getElementById('improvements').value,
         Notes: document.getElementById('notes').value,
         Score: score, TotalItems: total,
         Image1_Base64: uploadedImages[0] || '',
         Image2_Base64: uploadedImages[1] || '',
         Image3_Base64: uploadedImages[2] || ''
       };
       if(isUpdateMode) payload.ID = updateId;
       
       Swal.fire({
          title: 'ยืนยันบันทึก', text: `คะแนน ${score}/${total}`, icon: 'question', showCancelButton: true
       }).then(res => {
          if(res.isConfirmed) {
             document.getElementById('loading-spinner').classList.remove('hidden');
             if(typeof google !== 'undefined' && google.script) {
                const runner = google.script.run.withSuccessHandler(res => handleSaveSuccess(res, isUpdateMode?'update':'save'));
                if(isUpdateMode) runner.updateDataInSheet(payload.ID, payload);
                else runner.saveAssessmentData(payload);
             }
          }
       });
    }

    function handleSaveSuccess(res, mode) {
       document.getElementById('loading-spinner').classList.add('hidden');
       if(res.status === 'success') {
          Swal.fire('สำเร็จ', res.message, 'success');
          clearAll();
          loadInitialData();
          if(mode==='update') showPage('history');
       } else Swal.fire('Error', res.message, 'error');
    }
    
    function deleteRecord(id) {
        Swal.fire({title:'ยืนยันลบ', icon:'warning', showCancelButton:true}).then(r=>{
            if(r.isConfirmed) {
                document.getElementById('loading-spinner').classList.remove('hidden');
                google.script.run.withSuccessHandler(res => handleSaveSuccess(res,'delete')).deleteAssessmentRecord(id);
            }
        });
    }

    function clearAll() {
       document.getElementById('assessment-date').valueAsDate = new Date();
       ['supervisor','TeacherName','tumbon','class-level','assessment-round','strengths','improvements','notes','image-upload'].forEach(id=>{
           const el = document.getElementById(id);
           if(el) el.value = '';
       });
       document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active'));
       document.querySelectorAll('.assessment-item').forEach(i=>delete i.dataset.status);
       document.getElementById('image-preview-container').innerHTML = '';
       uploadedImages = [];
       isUpdateMode = false; updateId = null;
       const btn = document.getElementById('btn-save');
       btn.innerText = 'บันทึกข้อมูล'; btn.classList.replace('bg-blue-600','bg-primary');
    }

    function refreshAllData(data) {
       displayHistory(data);
       updateDashboard(data);
       populateSelectors(data);
       renderSummaryCharts(data);
       renderReportTable();
    }
    
    // --- Login System ---
    function openLoginModal() { 
        document.getElementById('login-modal').classList.remove('hidden');
        document.getElementById('admin-password-input').value=''; 
    }
    function closeLoginModal() { document.getElementById('login-modal').classList.add('hidden'); }
    
    function handleLogin() {
        const p = document.getElementById('admin-password-input').value;
        document.getElementById('loading-spinner').classList.remove('hidden');
        google.script.run.withSuccessHandler(res => {
            document.getElementById('loading-spinner').classList.add('hidden');
            if(res.status === 'success') {
                localStorage.setItem('isAdmin', 'true');
                closeLoginModal();
                checkLoginState();
                Swal.fire({icon:'success', title:'เข้าสู่ระบบแล้ว', toast:true, position:'top-end', timer:3000, showConfirmButton:false});
            } else Swal.fire('รหัสผ่านผิด', '', 'error');
        }).verifyAdminPassword(p);
    }
    
    function handleLogout() {
        Swal.fire({title:'ออกจากระบบ?', showCancelButton:true, confirmButtonColor:'#EF4444'}).then(r=>{
            if(r.isConfirmed) {
                localStorage.removeItem('isAdmin');
                checkLoginState();
                showPage('data');
                Swal.fire({icon:'success', title:'ออกจากระบบเรียบร้อย', timer:1500, showConfirmButton:false});
            }
        });
    }
    
    function checkLoginState() {
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        if(isAdmin) {
            document.body.classList.add('is-admin-mode');
            document.getElementById('btn-login').classList.add('hidden'); document.getElementById('btn-logout').classList.remove('hidden');
            document.getElementById('btn-login-mobile').classList.add('hidden'); document.getElementById('btn-logout-mobile').classList.remove('hidden');
            document.getElementById('nav-assessment-mobile').classList.remove('hidden');
        } else {
            document.body.classList.remove('is-admin-mode');
            document.getElementById('btn-login').classList.remove('hidden'); document.getElementById('btn-logout').classList.add('hidden');
            document.getElementById('btn-login-mobile').classList.remove('hidden'); document.getElementById('btn-logout-mobile').classList.add('hidden');
            document.getElementById('nav-assessment-mobile').classList.add('hidden');
        }
    }

    // --- Helpers ---
    function getSafeValue(record, key) { 
        if (!record || !key) return '';
        return record[key] || record[key.toLowerCase()] || record[key.toUpperCase()] || ''; 
    }
    function isPositive(val) { 
        if (!val) return false;
        const s = val.toString().trim().toLowerCase(); 
        return ['มี', 'true', '1', 'yes', 'checked', 'has'].includes(s);
    }

    // --- History & Dashboard ---
    function displayHistory(data) {
        const container = document.getElementById('history-content');
        if(!data.length) { container.innerHTML='<div class="text-center text-slate-400">ไม่มีข้อมูล</div>'; return; }
        
        data.sort((a,b)=>new Date(b.AssessmentDate)-new Date(a.AssessmentDate));
        container.innerHTML = data.map(item => {
            const p = (item.Score/item.TotalItems)*100;
            const badge = p>=80?'green':(p>=60?'amber':'red');
            return `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden group">
               <div class="p-4 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                     <div><span class="font-bold">${item.ClassLevel}</span> <span class="text-xs bg-slate-100 px-2 rounded">ครั้งที่ ${item.AssessmentRound}</span><p class="text-sm text-slate-500">${new Date(item.AssessmentDate).toLocaleDateString('th-TH')} | ${item.Supervisor}</p><p class="text-xs text-indigo-500 mt-1">ครู: ${item.TeacherName || '-'}</p></div>
                     <span class="px-3 py-1 rounded-full text-sm font-bold border text-${badge}-600 bg-${badge}-50 border-${badge}-200">${p.toFixed(0)}%</span>
                  </div>
               </div>
               <div class="hidden bg-slate-50 p-4 border-t text-sm space-y-2">
                  <p><strong>จุดเด่น:</strong> ${item.Strengths||'-'}</p>
                  <p><strong>ควรพัฒนา:</strong> ${item.Improvements||'-'}</p>
                  <div class="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-200">
                      <button onclick="editRecord('${item.ID}')" class="admin-only-element px-3 py-1 bg-amber-500 text-white rounded hover:bg-amber-600">แก้ไข</button>
                      <button onclick="deleteRecord('${item.ID}')" class="admin-only-element px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">ลบ</button>
                  </div>
               </div>
            </div>`;
        }).join('');
    }
    
    function editRecord(id) {
        const r = allAssessments.find(x => x.ID.toString() === id.toString());
        if(!r) return;
        ['AssessmentDate','Supervisor','TeacherName','Tumbon','ClassLevel','AssessmentRound','Strengths','Improvements','Notes'].forEach(k => {
           const el = document.getElementById(k) || document.getElementById(k.charAt(0).toLowerCase() + k.slice(1)) || document.getElementById(k.replace(/([A-Z])/g, '-$1').toLowerCase());
           if(el) el.value = (k==='AssessmentDate' && r[k]) ? r[k].split('T')[0] : (r[k] || '');
        });
        document.querySelectorAll('.assessment-item').forEach(i => {
           const val = getSafeValue(r, i.dataset.id);
           const st = isPositive(val) ? 'has' : 'not-has';
           setStatus(i.querySelector('.'+st), st);
        });
        uploadedImages = []; document.getElementById('image-preview-container').innerHTML = '';
        isUpdateMode = true; updateId = id;
        const btn = document.getElementById('btn-save');
        btn.innerHTML = 'อัปเดตข้อมูล'; btn.classList.replace('bg-primary','bg-blue-600');
        showPage('assessment');
    }
    
    function updateDashboard(data) {
        document.getElementById('total-assessments').textContent = data.length;
        const total = data.reduce((s,i)=>s+(i.Score/i.TotalItems),0);
        document.getElementById('avg-score').textContent = data.length ? ((total/data.length)*100).toFixed(1)+'%' : '0%';
        document.getElementById('total-supervisors').textContent = new Set(data.map(d=>d.Supervisor)).size;
        document.getElementById('total-Tumbon').textContent = new Set(data.map(d=>d.Tumbon)).size;
        
        const gridContainer = document.getElementById('data-card-grid');
        if (data.length === 0) {
            gridContainer.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400 bg-white rounded-xl border border-slate-200 border-dashed"><i class="fas fa-inbox text-4xl mb-3"></i><p>ยังไม่มีข้อมูลการนิเทศ</p></div>`;
            return;
        }
        const recentData = data.sort((a,b)=>new Date(b.AssessmentDate)-new Date(a.AssessmentDate)).slice(0, 12);
        gridContainer.innerHTML = recentData.map(i => {
            const percent = (i.Score / i.TotalItems) * 100;
            let badgeClass = 'bg-red-50 text-red-600 border-red-100';
            if (percent >= 80) badgeClass = 'bg-green-50 text-green-600 border-green-100';
            else if (percent >= 60) badgeClass = 'bg-amber-50 text-amber-600 border-amber-100';
            return `<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 hover:shadow-md hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between h-full group"><div><div class="flex justify-between items-start mb-3"><div class="flex items-center gap-2 text-xs font-medium text-slate-400 bg-slate-50 px-2 py-1 rounded-md"><i class="far fa-calendar-alt"></i> ${new Date(i.AssessmentDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })}</div><span class="${badgeClass} border px-2 py-1 rounded-lg text-xs font-bold shadow-sm">${i.Score}/${i.TotalItems} <span class="ml-1 text-[10px] opacity-75">(${percent.toFixed(0)}%)</span></span></div><h3 class="font-bold text-slate-800 text-lg mb-1 group-hover:text-primary transition-colors">${i.Tumbon}</h3><div class="space-y-3 mt-4"><div class="flex items-center gap-3 text-sm text-slate-600"><div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 shrink-0"><i class="fas fa-graduation-cap text-xs"></i></div><span class="truncate">${i.ClassLevel}</span></div><div class="flex items-center gap-3 text-sm text-slate-600"><div class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 shrink-0"><i class="fas fa-user-tie text-xs"></i></div><span class="truncate text-xs sm:text-sm">${i.Supervisor}</span></div></div></div></div>`;
        }).join('');
    }

    function populateSelectors(data) {
       const opts = data.map(d=>`<option value="${d.ID}">${new Date(d.AssessmentDate).toLocaleDateString('th-TH')} - ${d.ClassLevel} (${d.TeacherName || 'ไม่ระบุ'})</option>`).join('');
       ['details-selector','comparison-selector-1','comparison-selector-2'].forEach(id => document.getElementById(id).innerHTML = '<option value="">เลือกรายการ...</option>'+opts);
       const tum = [...new Set(data.map(d=>d.Tumbon))].filter(Boolean);
       document.getElementById('filter-Tumbon').innerHTML = '<option value="">ทุกตำบล</option>' + tum.map(t=>`<option value="${t}">${t}</option>`).join('');
       document.getElementById('report-filter-tumbon').innerHTML = '<option value="">ทั้งหมด</option>' + tum.map(t=>`<option value="${t}">${t}</option>`).join('');
    }
    
    function filterHistory() { 
        const t = document.getElementById('filter-Tumbon').value;
        displayHistory(allAssessments.filter(d => !t || d.Tumbon === t)); 
    }
    
    function onFailure(e) { 
        document.getElementById('loading-spinner').classList.add('hidden'); 
        Swal.fire('Error', e.message, 'error');
    }

    // --- Charts ---
    function renderDetailsCharts() {
       const id = document.getElementById('details-selector').value;
       const container = document.getElementById('details-charts-container');
       if(!id || id==='เลือกรายการ...' || id.includes('กำลังโหลด')) { container.classList.add('hidden'); return; }
       container.classList.remove('hidden');
       
       const rec = allAssessments.find(r => r.ID.toString() === id.toString());
       if(!rec) return;
       const catData = Object.keys(questionMapping).map(k => {
          const qs = questionMapping[k];
          let score=0; qs.forEach(q => { if(isPositive(getSafeValue(rec, q))) score++; });
          return qs.length ? (score/qs.length)*100 : 0;
       });
       drawChart('details-chart-1', 'bar', Object.keys(questionMapping), [{label:'%', data:catData, backgroundColor:'#4F46E5', borderRadius:4}]);
       
       const actData = Object.keys(activityStepMapping).map(k => {
          const qs = activityStepMapping[k];
          let score=0; qs.forEach(q => { if(isPositive(getSafeValue(rec, q))) score++; });
          return qs.length ? (score/qs.length)*100 : 0;
       });
       drawChart('details-chart-2', 'doughnut', Object.keys(activityStepMapping), [{data:actData, backgroundColor:['#F59E0B','#10B981','#EF4444'], borderWidth:0}]);
    }
    
    function renderSummaryCharts(data) {
       if(!data.length) return;
       const cats = Object.keys(questionMapping);
       const catAvg = cats.map(c => {
           let sum=0, count=0;
           data.forEach(d => { questionMapping[c].forEach(q => { if(isPositive(getSafeValue(d, q))) sum++; count++; }); });
           return count?(sum/count)*100:0;
       });
       drawChart('summary-chart-by-category', 'bar', cats, [{label:'%', data:catAvg, backgroundColor:'#4F46E5'}]);
       
       const sups = [...new Set(data.map(d=>d.Supervisor))];
       const supAvg = sups.map(s => {
          const sub = data.filter(d=>d.Supervisor===s);
          return (sub.reduce((a,b)=>a+(b.Score/b.TotalItems),0)/sub.length)*100;
       });
       drawChart('summary-chart-by-supervisor', 'pie', sups, [{data:supAvg, backgroundColor:['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6']}]);
       
       const cls = [...new Set(data.map(d=>d.ClassLevel))];
       const clsAvg = cls.map(c => {
          const sub = data.filter(d=>d.ClassLevel===c);
          return (sub.reduce((a,b)=>a+(b.Score/b.TotalItems),0)/sub.length)*100;
       });
       drawChart('summary-chart-by-class', 'bar', cls, [{label:'%', data:clsAvg, backgroundColor:'#F97316'}], {indexAxis:'y'});
    }
    
    function renderComparisonChart() {
       const id1 = document.getElementById('comparison-selector-1').value;
       const id2 = document.getElementById('comparison-selector-2').value;
       const container = document.getElementById('comparison-chart-container');
       if(!id1 || !id2) { container.classList.add('hidden'); return; }
       container.classList.remove('hidden');
       
       const r1 = allAssessments.find(r=>r.ID.toString()===id1);
       const r2 = allAssessments.find(r=>r.ID.toString()===id2);
       if(!r1 || !r2) return;
       const calc = (r) => Object.keys(questionMapping).map(k => {
           const qs = questionMapping[k];
           let score=0; qs.forEach(q => { if(isPositive(getSafeValue(r, q))) score++; });
           return qs.length ? (score/qs.length)*100 : 0;
       });
       drawChart('comparison-chart', 'radar', Object.keys(questionMapping), [
           {label:'ชุดที่ 1', data:calc(r1), borderColor:'red', backgroundColor:'rgba(255,0,0,0.2)'},
           {label:'ชุดที่ 2', data:calc(r2), borderColor:'blue', backgroundColor:'rgba(0,0,255,0.2)'}
       ]);
    }

    function drawChart(id, type, labels, datasets, extraOpts={}) {
       if(chartInstances[id]) chartInstances[id].destroy();
       const ctx = document.getElementById(id);
       chartInstances[id] = new Chart(ctx, {
           type: type, data: {labels, datasets},
           options: { responsive:true, maintainAspectRatio:false, scales:type==='pie'||type==='doughnut'?{}:{y:{beginAtZero:true, max:100}}, ...extraOpts }
       });
    }

    // --- Report Table & Print Logic ---
    function renderReportTable() {
        const searchTerm = document.getElementById('report-search').value.toLowerCase();
        const filterTumbon = document.getElementById('report-filter-tumbon').value;
        const filteredData = allAssessments.filter(item => {
            const matchesSearch = (getSafeValue(item,'Supervisor').toLowerCase().includes(searchTerm)) || (getSafeValue(item,'Tumbon').toLowerCase().includes(searchTerm)) || (getSafeValue(item,'ClassLevel').toLowerCase().includes(searchTerm));
            const matchesTumbon = filterTumbon === '' || item.Tumbon === filterTumbon;
            return matchesSearch && matchesTumbon;
        });
        
        const tbody = document.getElementById('report-table-body');
        const mobileList = document.getElementById('report-mobile-list');
        const emptyState = document.getElementById('report-empty-state');
        
        if (filteredData.length === 0) { 
            tbody.innerHTML = ''; 
            mobileList.innerHTML = '';
            emptyState.classList.remove('hidden'); 
            return; 
        }

        emptyState.classList.add('hidden');
        filteredData.sort((a,b) => new Date(b.AssessmentDate) - new Date(a.AssessmentDate));
        
        // 1. Desktop Table Render
        tbody.innerHTML = filteredData.map(item => {
            const percent = (item.Score / item.TotalItems) * 100;
            let badgeColor = percent >= 80 ? 'green' : (percent >= 60 ? 'amber' : 'red');
            return `<tr class="hover:bg-slate-50 transition-colors"><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${new Date(item.AssessmentDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })}</td><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900">${item.Tumbon}</div><div class="text-xs text-slate-500">${item.ClassLevel} (ครั้งที่ ${item.AssessmentRound})</div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.Supervisor}</td><td class="px-6 py-4 whitespace-nowrap text-center"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-${badgeColor}-100 text-${badgeColor}-800">${percent.toFixed(0)}%</span></td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium"><button onclick="printReport('${item.ID}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-200 hover:bg-indigo-100 transition-all shadow-sm"><i class="fas fa-print mr-1"></i> พิมพ์รายงาน</button></td></tr>`;
        }).join('');

        // 2. Mobile Card List Render (New Feature)
        mobileList.innerHTML = filteredData.map(item => {
            const percent = (item.Score / item.TotalItems) * 100;
            let badgeClass = percent >= 80 ? 'bg-green-100 text-green-800' : (percent >= 60 ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-800');
            return `
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-3">
                <div class="flex justify-between items-start">
                    <div>
                         <h4 class="font-bold text-slate-800">${item.Tumbon}</h4>
                         <p class="text-xs text-slate-500 mt-1">${item.ClassLevel}</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-bold rounded-full ${badgeClass}">${percent.toFixed(0)}%</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-500 bg-slate-50 p-2 rounded-lg">
                    <i class="far fa-calendar-alt"></i> ${new Date(item.AssessmentDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })}
                    <span class="mx-1 text-slate-300">|</span>
                    <i class="fas fa-user-tag"></i> ${item.Supervisor}
                </div>
                <button onclick="printReport('${item.ID}')" class="w-full mt-1 py-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-print"></i> พิมพ์รายงาน
                </button>
            </div>`;
        }).join('');
    }

    function printReport(specificId = null) {
        let id = specificId || document.getElementById('details-selector').value;
        const rec = allAssessments.find(r => r.ID.toString() === id.toString());
        if (!rec) return;

        // 1. เติมข้อมูลลงในฟอร์มพิมพ์
        document.getElementById('p-tumbon').textContent = rec.Tumbon;
        document.getElementById('p-date').textContent = new Date(rec.AssessmentDate).toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric'});
        document.getElementById('p-class').textContent = rec.ClassLevel;
        document.getElementById('p-round').textContent = rec.AssessmentRound;
        document.getElementById('p-supervisor').textContent = rec.Supervisor;
        document.getElementById('p-sign-name').textContent = rec.Supervisor;
        document.getElementById('p-teacher-name').textContent = rec.TeacherName || '-';
        document.getElementById('p-sign-teacher').textContent = rec.TeacherName ? `   ${rec.TeacherName}   ` : '............................................................';

        document.getElementById('p-strengths').textContent = rec.Strengths || '-';
        document.getElementById('p-improvements').textContent = rec.Improvements || '-';
        document.getElementById('p-notes').textContent = rec.Notes || '-';
        
        // 2. สร้างตารางประเมิน (ย่อคำเพื่อประหยัดที่)
        let tbodyHtml = '';
        assessmentStructure.forEach(section => {
            tbodyHtml += `<tr class="bg-gray-50"><td colspan="2" class="border border-black p-1 font-bold">${section.title}</td></tr>`;
            const processItems = (items) => {
                items.forEach(item => {
                    const val = getSafeValue(rec, item.id);
                    const result = isPositive(val) ? '<span class="text-green-600 font-bold">/</span>' : '<span class="text-red-600">-</span>';
                    tbodyHtml += `<tr><td class="border border-black p-1 pl-2">${item.text}</td><td class="border border-black p-1 text-center">${result}</td></tr>`;
                });
            };
            if (section.subsections) section.subsections.forEach(sub => { 
                tbodyHtml += `<tr><td colspan="2" class="border border-black p-1 pl-2 italic text-gray-600">${sub.subtitle}</td></tr>`; 
                processItems(sub.items); 
            });
            else processItems(section.items);
        });
        const percent = ((rec.Score / rec.TotalItems) * 100).toFixed(2);
        tbodyHtml += `
            <tr class="font-bold bg-gray-100 break-inside-avoid">
                <td class="border border-black p-1 text-right">สรุปผลการประเมิน (คิดเป็นร้อยละ)</td>
                <td class="border border-black p-1 text-center">${rec.Score}/${rec.TotalItems} (${percent}%)</td>
            </tr>
        `;
        document.getElementById('p-table-body').innerHTML = tbodyHtml;
        
        // 3. จัดการรูปภาพและเตรียมคำสั่งพิมพ์
        const imgContainer = document.getElementById('p-images-container');
        imgContainer.innerHTML = '<p class="text-gray-500 italic animate-pulse text-center col-span-3">กำลังโหลดรูปภาพเพื่อเตรียมพิมพ์...</p>';
        document.getElementById('loading-spinner').classList.remove('hidden');

        google.script.run
            .withSuccessHandler((response) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                imgContainer.innerHTML = ''; 
                if (response.status === 'success' && response.images.length > 0) {
                    response.images.forEach(base64 => {
                        // ปรับขนาดรูปใน JS ให้เล็กลงสำหรับการพิมพ์
                        imgContainer.innerHTML += `<img src="${base64}" style="max-height: 4cm; width: 100%; object-fit: cover;">`;
                    });
                } else {
                    imgContainer.innerHTML = '<p class="text-gray-400 italic text-center w-full col-span-3">- ไม่มีภาพประกอบ -</p>';
                }
        
                // ยืนยันก่อนพิมพ์
                Swal.fire({
                    title: 'เตรียมรายงานเสร็จแล้ว',
                    text: 'ต้องการพิมพ์รายงานฉบับนี้หรือไม่?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonColor: '#4F46E5',
                    confirmButtonText: '<i class="fas fa-print"></i> พิมพ์รายงาน',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        setTimeout(() => { window.print(); }, 500);
                    }
                });
            })
            .withFailureHandler((e) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                imgContainer.innerHTML = '<p class="text-red-500 italic text-center w-full col-span-3">ไม่สามารถโหลดรูปภาพได้</p>';
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถโหลดรูปภาพได้ แต่คุณยังพิมพ์ข้อมูลได้', 'warning')
                    .then(() => { window.print(); });
            })
            .getReportImages(id);
    }
  </script>
</body>
</html>
